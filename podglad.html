<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>üßæ Edycja faktur</title>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<style>
body {
  font-family: sans-serif;
  background: #f4f4f4 url('tlo.jpg') no-repeat right bottom fixed;
  background-size: contain;
  color: #fff;
  padding: 2rem;
}
h1 {
  font-family: 'Pacifico', cursive;
  color: #000;
  text-align: center;
}
.table-box {
  background: rgba(0,0,0,0.85);
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  overflow-x: auto;
}
table {
  width: 100%;
  border-collapse: collapse;
  color: #fff;
}
th, td {
  border-bottom: 1px solid #444;
  padding: 6px;
  vertical-align: top;
}
th {
  background: rgba(255,255,255,0.1);
  position: sticky;
  top: 0;
}
td[contenteditable="true"] {
  background: rgba(255,255,255,0.05);
  cursor: text;
}
td:focus {
  outline: 2px solid #48f;
}
.toggle { cursor: pointer; color: #48f; text-decoration: underline; }
.subtable { display: none; background: rgba(0,0,0,0.7); border-radius: 8px; margin-top: .5rem; padding: .5rem; }
.status { font-size: 0.8rem; margin-left: .5rem; }
.status.ok { color: #0f0; }
.status.err { color: #f44; }
</style>
</head>
<body>
<h1>üßæ Edycja faktur</h1>
<div class="table-box" id="table-container">≈Åadowanie...</div>

<script>
const API_BASE = "http://vps15151.awhost.cloud:420/api";

async function loadFaktury() {
  const c = document.getElementById('table-container');
  try {
    const res = await fetch(`${API_BASE}/faktury`);
    const data = await res.json();
    if (!data.length) return c.innerHTML = "<p>Brak faktur</p>";

    let html = `<table>
      <thead><tr>
        <th>Nr</th><th>Rodzaj</th><th>Sprzedawca</th><th>Nabywca</th>
        <th>Daty</th><th>Waluta</th><th>Bank</th>
        <th>P≈Çatno≈õƒá</th><th>Netto</th><th>VAT</th><th>Brutto</th><th>Pozycje</th>
      </tr></thead><tbody>`;

    for (const f of data) {
      html += `<tr data-nr="${f.numer_faktury}">
        <td>${esc(f.numer_faktury)}</td>
        <td contenteditable="true" data-field="rodzaj_dokumentu">${esc(f.rodzaj_dokumentu)}</td>
        <td contenteditable="true" data-field="sprzedawca.nazwa">${esc(f.sprzedawca?.nazwa)}</td>
        <td contenteditable="true" data-field="nabywca.nazwa">${esc(f.nabywca?.nazwa)}</td>
        <td contenteditable="true" data-field="daty.data_wystawienia">${esc(f.daty?.data_wystawienia)}</td>
        <td contenteditable="true" data-field="waluta">${esc(f.waluta)}</td>
        <td contenteditable="true" data-field="bank">${esc(f.bank)}</td>
        <td contenteditable="true" data-field="sposob_platnosci">${esc(f.sposob_platnosci)}</td>
        <td contenteditable="true" data-field="suma_netto">${num(f.suma_netto)}</td>
        <td contenteditable="true" data-field="suma_vat">${num(f.suma_vat)}</td>
        <td contenteditable="true" data-field="suma_brutto">${num(f.suma_brutto)}</td>
        <td><span class="toggle" onclick="toggleDetails(this)">Poka≈º</span>
          <div class="subtable">${renderPozycje(f)}</div></td>
      </tr>`;
    }
    html += `</tbody></table>`;
    c.innerHTML = html;
    addEditHandlers();
  } catch (e) {
    c.innerHTML = `<p style="color:red;">‚ùå B≈ÇƒÖd: ${esc(e.message)}</p>`;
  }
}

function renderPozycje(f) {
  if (!f.pozycje?.length) return "<em>Brak pozycji</em>";
  return `<table><thead><tr><th>Nazwa</th><th>Ilo≈õƒá</th><th>Warto≈õƒá</th></tr></thead>
    <tbody>${f.pozycje.map(p=>`<tr><td>${esc(p.nazwa)}</td><td>${esc(p.ilosc)}</td><td>${num(p.wartosc_brutto)}</td></tr>`).join('')}</tbody></table>`;
}

function toggleDetails(el) {
  const sub = el.nextElementSibling;
  sub.style.display = sub.style.display === "block" ? "none" : "block";
  el.textContent = sub.style.display === "block" ? "Ukryj" : "Poka≈º";
}

function addEditHandlers() {
  document.querySelectorAll('[contenteditable="true"]').forEach(td => {
    td.addEventListener('blur', saveEdit);
    td.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        td.blur();
      }
    });
  });
}

async function saveEdit(e) {
  const td = e.target;
  const row = td.closest('tr');
  const nr = row.dataset.nr;
  const field = td.dataset.field;
  const value = td.textContent.trim();
  const status = document.createElement('span');
  status.className = 'status';
  td.appendChild(status);

  try {
    const res = await fetch(`${API_BASE}/faktura/update`, {
      method: 'PATCH',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ numer_faktury: nr, field, value })
    });
    const r = await res.json();
    if (r.status === 'updated') {
      status.textContent = '‚úÖ';
      status.classList.add('ok');
    } else throw new Error(r.error || 'B≈ÇƒÖd');
  } catch {
    status.textContent = '‚ùå';
    status.classList.add('err');
  }
  setTimeout(()=>status.remove(), 1500);
}

function esc(s){return String(s??'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m]))}
function num(v){return v!=null?Number(v).toFixed(2):'';}

loadFaktury();
</script>
</body>
</html>

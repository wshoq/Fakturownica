<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>ü¶Ü kFak-Tour's</title>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Dancing+Script:wght@700&family=Lobster&display=swap" rel="stylesheet">
<style>
body { 
    font-family: sans-serif; 
    padding: 2rem; 
    text-align: center; 
    position: relative; 
    overflow-x: hidden;
    color: #000;
    background:#f4f4f4;
}
#background {
    position: fixed;
    bottom: 0;
    right: 0;
    width: auto;
    max-width: 100%;
    height: auto;
    opacity: 0.5;
    z-index: 0;
    pointer-events: none;
    background: url('tlo.jpg') no-repeat right bottom;
    background-size: contain;
}
#mati {
    position: fixed;
    top: 12%;
    left: -5%;
    width: 400px;
    height: auto;
    opacity: 1;
    pointer-events: none;
    transition: all 1s ease-in-out;
    z-index: 3;
}
#gif {
    position: fixed;
    left: 10px;
    bottom: -500px;
    width: 400px;
    height: auto;
    opacity: 1;
    pointer-events: none;
    transition: all 2s ease-in-out;
    z-index: 2;
    mix-blend-mode: multiply;
    filter: contrast(1.5);
}
h1 { 
    margin-bottom:2rem;
    font-family: 'Pacifico', cursive;
    font-size: 3rem;
    color: #000;
}
.subtitle {
    font-family: 'Dancing Script', cursive;
    font-weight: 700;
    font-size: 1.8rem;
    margin-bottom: 1rem;
    color: #000;
}
h2 {
    margin-top:2rem;
    font-family: 'Lobster', cursive;
    font-size: 2rem;
    color: #000;
}
#status-text {
    margin-top:1rem;
    font-weight:bold;
    font-size:1.1rem;
    color: #000;
}
.drop-area{
    border:3px dashed #fff;
    border-radius:12px;
    padding:3rem 2rem;
    width: 92%;
    background: rgba(0,0,0,0.85);
    color:#fff;
    font-size:1.3rem;
    font-weight:bold;
    cursor:pointer;
    user-select:none;
    box-sizing:border-box;
    margin:0 auto;
    max-width:920px;
    z-index: 3;
    position: relative;
    transition: all 0.2s ease;
}
.drop-area.dragover{background-color: rgba(50,50,50,0.9); border-color:#36f;}
#file-name{margin-top:1rem;font-weight:bold;color:#fff;}
#uploadBtn{
    margin:1.5rem auto;
    padding:0.6rem 1.2rem;
    font-size:1rem;
    cursor:pointer;
    border-radius:6px;
    border:1px solid #36f;
    background-color:#48f;
    color:white;
    display:block; 
    max-width:200px;
    z-index: 3;
    position: relative;
}
#uploadBtn:not(:disabled):hover{background-color:#3570d8;}
#fileElem{display:none;}
#tour-box{
    max-width:920px;
    margin:1rem auto;
    background: rgba(0,0,0,0.85);
    border-radius:12px;
    padding:1rem;
    text-align:left;
    box-shadow:0 2px 6px rgba(0,0,0,0.2);
    max-height:320px;
    overflow:auto;
    position: relative; 
    z-index: 3;
    color:#fff;
    font-size:0.95rem;
}
#tour-box .f-header{
    display:flex;
    gap:12px;
    padding:6px;
    font-weight:bold;
    border-bottom:1px solid #fff;
}
.f-row{
    display:flex;
    gap:12px;
    padding:6px;
    border-bottom:1px solid #333;
    align-items:center;
}
.f-row strong{ flex: 2 1 40%; }
.f-row .nabywca{ flex: 2 1 40%; }
.f-row .num{ flex: 1 1 10%; text-align:right; color:#fff; }
.empty{color:#ccc;padding:1rem;text-align:center;}
#progressBar{
    width:46%;
    height:16px;
    background:#eee;
    border:1px solid #333;
    border-radius:8px;
    margin:0.5rem auto;
    overflow:hidden;
}
#progressFill{width:0%;height:100%;background:#48f;transition:width 0.3s;}
#fullTourBtn {
    margin-left: 1rem;
    padding:0.6rem 1rem;
    border-radius:6px;
    background:#222;
    color:#fff;
    border:1px solid #555;
    cursor:pointer;
}
#fullTourBtn:hover{background:#333;}
</style>
</head>
<body>
<img id="background" src="tlo.jpg" alt="t≈Ço">
<img id="mati" src="mati.png" alt="mati">
<img id="gif" src="1.gif" alt="gif">

<h1>ü¶Ü kFak-Tour's üå¥</h1>
<div class="subtitle">Tƒôdy proszƒô</div>

<div id="drop-area" class="drop-area">
  <p>Upu≈õƒá PDF tutaj lub kliknij, aby wybraƒá</p>
  <input type="file" id="fileElem" accept="application/pdf" multiple />
  <p id="file-name"></p>
</div>

<button id="uploadBtn" type="button" disabled>kFak-tour</button>
<div id="status-text"></div>
<div id="progressBar"><div id="progressFill"></div></div>

<h2>üöå On Tour...</h2>
<div id="tour-box">
    <div class="f-header">
        <div style="flex:2">Sprzedawca</div>
        <div style="flex:2">Nabywca</div>
        <div style="flex:1">Wart. brutto</div>
    </div>
    <div class="empty">≈Åadowanie listy faktur...</div>
</div>

<div style="display:flex;justify-content:center;gap:1rem;">
    <button id="generateXmlBtn" type="button">üéØ Zako≈Ñcz Tour i Generuj XML</button>
    <button id="fullTourBtn" type="button">ü™Ñ Ca≈Çy Tour</button>
</div>

<script>
const BACKEND_URL = "/Fakturownica/api/";
const dropArea = document.getElementById("drop-area");
const fileElem = document.getElementById("fileElem");
const fileNameDisplay = document.getElementById("file-name");
const uploadBtn = document.getElementById("uploadBtn");
const statusText = document.getElementById("status-text");
const tourBox = document.getElementById('tour-box');
const generateXmlBtn = document.getElementById('generateXmlBtn');
const progressFill = document.getElementById('progressFill');
const mati = document.getElementById("mati");
const gif = document.getElementById("gif");

let queueFiles = [];
let jobId = null;
let pollInterval = null;

// === DRAG&DROP ===
["dragenter","dragover"].forEach(evt=>{
  dropArea.addEventListener(evt,e=>{
    e.preventDefault();
    e.stopPropagation();
    dropArea.classList.add("dragover");
  });
});
["dragleave","drop"].forEach(evt=>{
  dropArea.addEventListener(evt,e=>{
    e.preventDefault();
    e.stopPropagation();
    dropArea.classList.remove("dragover");
  });
});
dropArea.addEventListener("drop",e=>{
  e.preventDefault();
  e.stopPropagation();
  const files = e.dataTransfer.files;
  handleFiles({target:{files}});
});
dropArea.addEventListener("click",()=>fileElem.click());
fileElem.addEventListener("change",handleFiles);

function handleFiles(e){
  const files = Array.from(e.target.files||[]);
  if(!files.length) return;
  for(let f of files){
    if(f.type!=='application/pdf'){
      fileNameDisplay.textContent="‚ùå Wszystkie pliki muszƒÖ byƒá PDF!";
      return;
    }
    queueFiles.push(f);
  }
  fileNameDisplay.textContent=`üìÑ Wybrano ${queueFiles.length} plik(√≥w)`;
  uploadBtn.disabled = queueFiles.length===0;
}

uploadBtn.addEventListener("click", async ()=>{
  if(queueFiles.length===0) return;
  mati.style.left = '-500px';
  mati.style.opacity = '0';
  const dropRect = dropArea.getBoundingClientRect();
  const maxWidth = dropRect.left - 20;
  gif.style.width = Math.min(400, maxWidth)+'px';
  setTimeout(()=>{ gif.style.bottom = (window.innerHeight - gif.offsetHeight*1.2)+'px'; }, 500);
  uploadBtn.disabled=true;
  statusText.textContent="‚è≥ Rozpoczynam wysy≈Çkƒô‚Ä¶";
  const formData=new FormData();
  queueFiles.forEach(f=>formData.append("files",f));
  try{
    const res = await fetch(`${BACKEND_URL}upload`,{method:"POST",body:formData});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    jobId = data.jobId;
    statusText.textContent=`‚úÖ Wys≈Çano, ID zadania: ${jobId}`;
    queueFiles = [];
    fileElem.value = "";
    fileNameDisplay.textContent = "";
    progressFill.style.width="0%";
    pollInterval=setInterval(fetchJobStatus,1000);
  }catch(err){ statusText.textContent=`‚ùå B≈ÇƒÖd: ${err.message}`; uploadBtn.disabled=false; }
});

let completedCount=0;
async function fetchJobStatus(){
  if(!jobId) return;
  try{
    const res = await fetch(`${BACKEND_URL}job-status/${jobId}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    completedCount=data.completed;
    const pct = data.total ? Math.round((completedCount/data.total)*100) : 0;
    progressFill.style.width=`${pct}%`;
    statusText.textContent=`Przetworzono ${completedCount} z ${data.total} plik√≥w (${pct}%)`;
    if(completedCount>=data.total){
      clearInterval(pollInterval); pollInterval=null;
      statusText.textContent+=" ‚úÖ Wszystkie pliki przetworzone!";
      setTimeout(()=>{ gif.style.bottom = window.innerHeight+'px'; }, 1000);
    }
  }catch(err){ console.error(err);}
}

async function fetchFaktury(){
  try{
    const res = await fetch(`${BACKEND_URL}faktury`);
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    if(!data.length){tourBox.innerHTML='<div class="empty">Brak faktur w bazie.</div>';return;}
    let html = `<div class="f-header"><div style="flex:2">Sprzedawca</div><div style="flex:2">Nabywca</div><div style="flex:1">Wart. brutto</div></div>`;
    html += data.map(f=>{
      const spr = escapeHtml(f.sprzedawca||'');
      const nab = escapeHtml(f.nabywca||'');
      const brutto = (f.wartosc_brutto!==undefined && f.wartosc_brutto!==null)?Number(f.wartosc_brutto).toFixed(2):'0.00';
      return `<div class="f-row"><strong>${spr}</strong><div class="nabywca">${nab}</div><div class="num">${brutto} PLN</div></div>`;
    }).join('');
    tourBox.innerHTML = html;
  }catch(err){tourBox.innerHTML=`<div class="empty">‚ùå B≈ÇƒÖd: ${escapeHtml(err.message)}</div>`;}
}
function escapeHtml(s){ if(!s&&s!==0) return''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

fetchFaktury(); setInterval(fetchFaktury,5000);

generateXmlBtn.addEventListener('click',async()=>{
  if(!confirm('Czy na pewno chcesz wygenerowaƒá XML i wyczy≈õciƒá bazƒô?')) return;
  generateXmlBtn.disabled=true;
  generateXmlBtn.textContent='Generowanie XML...';
  try{
    const resXml = await fetch(`${BACKEND_URL}faktury/xml`);
    if(!resXml.ok){const txt=await resXml.text();throw new Error(`HTTP ${resXml.status} - ${txt}`);}
    const blob = await resXml.blob();
    const url = window.URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download="faktury.xml";document.body.appendChild(a);a.click();a.remove();window.URL.revokeObjectURL(url);
    setTimeout(fetchFaktury,500);
  }catch(err){alert('B≈ÇƒÖd generowania XML: '+err.message);}
  finally{generateXmlBtn.disabled=false; generateXmlBtn.textContent='üéØ Zako≈Ñcz Tour i Generuj XML';}
});

// ‚úÖ Naprawiony przycisk podglƒÖdu
document.getElementById('fullTourBtn').addEventListener('click', ()=>{
  const win = window.open('podglad.html', 'PodgladBazy', 'width=1000,height=700,scrollbars=yes');
  if(!win) alert("‚ö†Ô∏è PrzeglƒÖdarka zablokowa≈Ça otwarcie okna ‚Äî zezw√≥l na popupy dla tej strony.");
});
</script>
</body>
</html>
